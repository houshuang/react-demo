/**!
© 2018 Convergence Labs, Inc.
@version 0.1.1
@license MIT
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).HtmlTextCollabExt={})}(this,function(t){"use strict";var e=function(){return(e=Object.assign||function(t){for(var e,o=1,n=arguments.length;o<n;o++)for(var i in e=arguments[o])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function o(t,e){return t(e={exports:{}},e.exports),e.exports}var n,s=o(function(t){var u,p,d;u=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],p="undefined"!=typeof window,d=p&&null!=window.mozInnerScreenX,t.exports=function(t,e,o){if(!p)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");var n=o&&o.debug||!1;if(n){var i=document.querySelector("#input-textarea-caret-position-mirror-div");i&&i.parentNode.removeChild(i)}var r=document.createElement("div");r.id="input-textarea-caret-position-mirror-div",document.body.appendChild(r);var s=r.style,l=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,h="INPUT"===t.nodeName;s.whiteSpace="pre-wrap",h||(s.wordWrap="break-word"),s.position="absolute",n||(s.visibility="hidden"),u.forEach(function(t){h&&"lineHeight"===t?s.lineHeight=l.height:s[t]=l[t]}),d?t.scrollHeight>parseInt(l.height)&&(s.overflowY="scroll"):s.overflow="hidden",r.textContent=t.value.substring(0,e),h&&(r.textContent=r.textContent.replace(/\s/g," "));var a=document.createElement("span");a.textContent=t.value.substring(e)||".",r.appendChild(a);var c={top:a.offsetTop+parseInt(l.borderTopWidth),left:a.offsetLeft+parseInt(l.borderLeftWidth),height:parseInt(l.lineHeight)};return n?a.style.backgroundColor="#aaa":document.body.removeChild(r),c}}),r=function(){function n(t,e,o){this.element=t,this.start=e,this.end=o,this.startCoordinates=s(t,e),this.endCoordinates=s(t,o),this.lineHeight=this.startCoordinates.height,this.elementPaddingLeft=parseFloat(t.style.paddingLeft)||0,this.elementPaddingRight=parseFloat(t.style.paddingRight)||0,this.elementPaddingX=this.elementPaddingLeft+this.elementPaddingRight,this.selectionRows=[],t.value.substr(e,o-e).indexOf("\n")<0?this.appendSingleLineSelection(this.startCoordinates,this.endCoordinates):this.buildMultiRowSelection()}return n.calculateSelection=function(t,e,o){return new n(t,e,o).selectionRows},n.prototype.appendSingleLineSelection=function(t,e){var o;(o=this.selectionRows).push.apply(o,this.buildSingleLineSelection(t,e))},n.prototype.buildSingleLineSelection=function(t,e){return t.top===e.top?[{width:e.left-t.left,top:t.top,left:t.left,height:this.lineHeight}]:this.buildWrappedLineSelections(t,e)},n.prototype.buildWrappedLineSelections=function(t,e){var o=[];return o.push({width:this.element.scrollWidth-this.elementPaddingRight-t.left,top:t.top,left:t.left,height:this.lineHeight}),e.top>t.top+this.lineHeight&&o.push({width:this.element.scrollWidth-this.elementPaddingX,left:this.elementPaddingLeft,top:t.top+this.lineHeight,height:e.top-t.top-this.lineHeight}),o.push({width:e.left-this.elementPaddingLeft,top:e.top,left:this.elementPaddingLeft,height:this.lineHeight}),o},n.prototype.buildMultiRowSelection=function(){for(var t=this.startCoordinates,e=+this.start;t.top<this.endCoordinates.top;){var o=this.element.value.indexOf("\n",e),n=this.element.value.length;0<=o&&(n=o),n>this.end&&(n=this.end);var i=s(this.element,n);this.appendSingleLineSelection(t,i),e=n+1,t=s(this.element,e)}if(e<this.end){var r={width:this.endCoordinates.left-t.left,top:t.top,left:t.left,height:this.lineHeight};this.selectionRows.push(r)}},n}(),l=function(){function t(t,e,o,n,i){this._label=n,this._textInput=t,this._color=o,this._cursor=null,this._selection=null,this._rows=[],this._container=e,i=i||{},this._margin=i.margin||5,this._tooltipTimeout=null,this._cursorElement=this._container.ownerDocument.createElement("div"),this._cursorElement.className="collaborator-cursor",this._cursorElement.style.backgroundColor=this._color,this._tooltipElement=this._container.ownerDocument.createElement("div"),this._tooltipElement.innerHTML=n,this._tooltipElement.className="collaborator-cursor-tooltip",this._tooltipElement.style.backgroundColor=this._color,this.hideCursorTooltip(),this.refresh()}return t.prototype.showSelection=function(){console.log("show selection");var t=s(this._textInput,this._cursor);console.log(t.left,this._container.offsetWidth),t.left<this._container.offsetWidth&&(console.log("yes"),this._rows.forEach(function(t){t.element.style.visibility="visible"}))},t.prototype.hideSelection=function(){this._rows.forEach(function(t){t.element.style.visibility="hidden"})},t.prototype.showCursor=function(){console.log("show cursor");var t=s(this._textInput,this._cursor);console.log(t.left,this._container.offsetWidth),t.left<this._container.offsetWidth&&(console.log("yes"),this._rows.forEach(function(t){t.element.style.visibility="visible"})),this._cursorElement.style.visibility="visible"},t.prototype.hideCursor=function(){this._cursorElement.style.visibility="hidden"},t.prototype.showCursorToolTip=function(){this._clearToolTipTimeout(),this._tooltipElement.style.opacity="1"},t.prototype.flashCursorToolTip=function(t){var e=this;this.showCursorToolTip(),this._clearToolTipTimeout(),this._tooltipTimeout=setTimeout(function(){return e.hideCursorTooltip()},1e3*t)},t.prototype.hideCursorTooltip=function(){this._clearToolTipTimeout(),this._tooltipElement.style.opacity="0"},t.prototype._clearToolTipTimeout=function(){null!==this._tooltipTimeout&&(clearTimeout(this._tooltipTimeout),this._tooltipTimeout=null)},t.prototype.setColor=function(t){var e=this;this._color=t,this._rows.forEach(function(t){t.element.style.background=e._color}),this._cursorElement.style.background=this._color,this._tooltipElement.style.background=this._color},t.prototype.setSelection=function(t){null===t?(this._cursor=null,this._selection=null):(this._cursor=t.target,this._selection=e({},t)),this.refresh()},t.prototype.getSelection=function(){return e({},this._selection)},t.prototype.clearSelection=function(){this.setSelection(null)},t.prototype.refresh=function(){this._updateCursor(),this._updateSelection()},t.prototype._updateCursor=function(){var t=s(this._textInput,this._cursor);if(console.log(t.left,this._container.offsetWidth),t.left>this._container.offsetWidth)return console.log("hide"),this.hideCursorTooltip(),void this.hideSelection();if(null===this._cursor&&this._container.contains(this._cursorElement))console.log("remove"),this._container.removeChild(this._cursorElement),this._container.removeChild(this._tooltipElement);else{this._cursorElement.parentElement||(console.log("add"),this._container.append(this._cursorElement),this._container.append(this._tooltipElement)),this._cursorElement.style.height=t.height+"px",this._cursorElement.style.top=t.top+"px";var e=t.left-this._cursorElement.offsetWidth/2;this._cursorElement.style.left=e+"px";var o=t.top-this._tooltipElement.offsetHeight;o+this._container.offsetTop<this._margin&&(o=t.top+t.height);var n=e;n+this._tooltipElement.offsetWidth>this._container.offsetWidth-this._margin&&(n=e+this._cursorElement.offsetWidth-this._tooltipElement.offsetWidth),this._tooltipElement.style.top=o+"px",this._tooltipElement.style.left=n+"px"}},t.prototype._updateSelection=function(){var n=this;if(null===this._selection)this._rows.forEach(function(t){return t.element.parentElement.removeChild(t.element)}),this._rows.splice(0,this._rows.length);else{var t=void 0,e=void 0;e=this._selection.anchor>this._selection.target?(t=Number(this._selection.target),Number(this._selection.anchor)):(t=Number(this._selection.anchor),Number(this._selection.target));var o=r.calculateSelection(this._textInput,t,e),i=o.length-this._rows.length;if(0<i)0===this._rows.length||this._rowsEqual(o[0],this._rows[0].rowData)?this._addNewRows(i,!0):this._addNewRows(i,!1);else if(i<0){(this._rowsEqual(o[0],this._rows[0].rowData)?this._rows.splice(this._rows.length-1+i,-1*i):this._rows.splice(0,-1*i)).forEach(function(t){return t.element.parentElement.removeChild(t.element)})}o.forEach(function(t,e){var o=n._rows[e];n._updateRow(t,o)})}},t.prototype._addNewRows=function(t,e){for(var o=0;o<t;o++){var n=this._container.ownerDocument.createElement("div");n.style.position="absolute",n.style.backgroundColor=this._color,n.style.opacity="0.25",this._container.append(n);var i={element:n,rowData:{height:0,width:0,top:0,left:0}};e?this._rows.push(i):this._rows.unshift(i)}},t.prototype._rowsEqual=function(t,e){return t.height===e.height&&t.width===e.width&&t.top===e.top&&t.left===e.left},t.prototype._updateRow=function(t,e){t.height!==e.rowData.height&&(e.rowData.height=t.height,e.element.style.height=t.height+"px"),t.width!==e.rowData.width&&(e.rowData.width=t.width,e.element.style.width=t.width+"px"),t.top!==e.rowData.top&&(e.rowData.top=t.top,e.element.style.top=t.top+"px"),t.left!==e.rowData.left&&(e.rowData.left=t.left,e.element.style.left=t.left+"px")},t}(),h=function(){function t(){}return t.transformIndexOnInsert=function(t,e,o){return e<=t?t+o.length:t},t.transformIndexOnDelete=function(t,e,o){return e<t?t-Math.min(t-e,o):t},t}(),a=function(){function t(t){var e=this;if(this._checkSelection=function(){setTimeout(function(){(e._textElement.selectionStart!==e._selectionAnchor||e._textElement.selectionEnd!==e._selectionTarget)&&(e._selectionAnchor===e._textElement.selectionStart?(e._selectionAnchor=e._textElement.selectionStart,e._selectionTarget=e._textElement.selectionEnd):(e._selectionAnchor=e._textElement.selectionEnd,e._selectionTarget=e._textElement.selectionStart),e._onSelection({anchor:e._selectionAnchor,target:e._selectionTarget}))},0)},this._onMouseMove=function(){e._checkResize(),e._checkSelection()},this._checkResize=function(){e._textElement.offsetWidth===e._overlayContainer.offsetWidth&&e._textElement.offsetHeight===e._overlayContainer.offsetHeight||(e._updateOverlay(),e._collaborators.forEach(function(t){return t.refresh()}))},this._collaborators=new Map,this._textElement=t.control,"normal"===window.getComputedStyle(this._textElement).lineHeight)throw new Error("Text areas must have a numeric line-height.");this._onSelection=t.onSelectionChanged,this._selectionAnchor=this._textElement.selectionStart,this._selectionTarget=this._textElement.selectionEnd,this._overlayContainer=this._textElement.ownerDocument.createElement("div"),this._overlayContainer.className="text-collab-ext",this._textElement.parentElement.append(this._overlayContainer),this._scroller=this._textElement.ownerDocument.createElement("div"),this._scroller.className="text-collab-ext-scroller",this._overlayContainer.append(this._scroller),this._textElement.addEventListener("mousedown",function(){window.addEventListener("mousemove",e._onMouseMove)}),window.addEventListener("mouseup",function(){window.removeEventListener("mousemove",e._onMouseMove),e._checkResize()}),this._textElement.addEventListener("scroll",function(){return e._updateScroller()}),this._textElement.addEventListener("keydown",this._checkSelection),this._textElement.addEventListener("click",this._checkSelection),this._textElement.addEventListener("focus",this._checkSelection),this._textElement.addEventListener("blur",this._checkSelection),this._updateOverlay()}return t.prototype.addCollaborator=function(t,e,o,n){if(this._collaborators.has(t))throw new Error("A collaborator with the specified id already exists: "+t);var i=new l(this._textElement,this._scroller,o,e,{margin:5});return this._collaborators.set(t,i),null!=n&&i.setSelection(n),i},t.prototype.getCollaborator=function(t){return this._collaborators.get(t)},t.prototype.removeCollaborator=function(t){var e=this._collaborators.get(t);if(void 0===e)throw new Error("Unknown collaborator: "+t);e.clearSelection(),this._collaborators.delete(t)},t.prototype.getSelection=function(){return{anchor:this._selectionAnchor,target:this._selectionTarget}},t.prototype.show=function(){this._overlayContainer.style.visibility="visible"},t.prototype.hide=function(){this._overlayContainer.style.visibility="hidden"},t.prototype.dispose=function(){this._overlayContainer.parentElement.removeChild(this._overlayContainer)},t.prototype.updateSelectionsOnInsert=function(i,r){this._collaborators.forEach(function(t){var e=t.getSelection(),o=h.transformIndexOnInsert(e.anchor,i,r),n=h.transformIndexOnInsert(e.target,i,r);t.setSelection({anchor:o,target:n})})},t.prototype.updateSelectionsOnDelete=function(i,r){this._collaborators.forEach(function(t){var e=t.getSelection(),o=h.transformIndexOnDelete(e.anchor,i,r),n=h.transformIndexOnDelete(e.target,i,r);t.setSelection({anchor:o,target:n})})},t.prototype._updateOverlay=function(){var t=this._textElement.offsetTop,e=this._textElement.offsetLeft,o=this._textElement.offsetHeight,n=this._textElement.offsetWidth;this._overlayContainer.style.top=t+"px",this._overlayContainer.style.left=e+"px",this._overlayContainer.style.height=o+"px",this._overlayContainer.style.width=n+"px"},t.prototype._updateScroller=function(){this._scroller.style.top=-1*this._textElement.scrollTop+"px",this._scroller.style.left=-1*this._textElement.scrollLeft+"px"},t}(),i=o(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function n(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,o){return e&&n(t.prototype,e),o&&n(t,o),t}}();e.StringChangeDetector=function(){function e(t){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("options must be defined");if("function"!=typeof t.onInsert)throw new Error("options.onInsert must be a function");if("function"!=typeof t.onRemove)throw new Error("options.onRemove must be a function");if("string"!=typeof t.value)throw new Error("options.value must be a string");this._onInsert=t.onInsert,this._onRemove=t.onRemove,this._value=t.value}return o(e,[{key:"insertText",value:function(t,e){var o=this._value,n=o.substring(0,t)+e+o.substring(t,o.length);this.setValue(n)}},{key:"removeText",value:function(t,e){var o=this._value,n=o.substring(0,t)+o.substring(t+e,o.length);this.setValue(n)}},{key:"setValue",value:function(t){this._value=t}},{key:"getValue",value:function(){return this._value}},{key:"processNewValue",value:function(t){var e=0,o=0;if(this._value!==t){for(;this._value.charAt(o)===t.charAt(o);)o++;for(;this._value.charAt(this._value.length-1-e)===t.charAt(t.length-1-e)&&e+o<this._value.length&&e+o<t.length;)e++;this._value.length!==o+e&&this._onRemove&&this._onRemove(o,this._value.length-o-e),t.length!==o+e&&this._onInsert&&this._onInsert(o,t.slice(o,t.length-e)),this._value=t}}}]),e}()});(n=i)&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")&&n.default;i.StringChangeDetector;var c=i.StringChangeDetector,u=function(){function t(t){var e=this;this._onLocalInput=function(){e._changeDetector.processNewValue(e._control.value)},this._control=t.control,this._onLocalInsert=t.onInsert,this._onLocalDelete=t.onDelete,this._changeDetector=null,this.bind()}return t.prototype.bind=function(){this._changeDetector=new c({value:this._control.value,onInsert:this._onLocalInsert,onRemove:this._onLocalDelete}),this._control.addEventListener("input",this._onLocalInput)},t.prototype.unbind=function(){this._control.removeEventListener("input",this._onLocalInput),this._changeDetector=null},t.prototype.insertText=function(t,e){this._assertBound();var o=this._getSelection(),n=o.start,i=o.end,r=h.transformIndexOnInsert(n,t,e),s=h.transformIndexOnInsert(i,t,e);this._changeDetector.insertText(t,e),this._updateControl(),this._setTextSelection(r,s)},t.prototype.deleteText=function(t,e){this._assertBound();var o=this._getSelection(),n=o.start,i=o.end,r=h.transformIndexOnDelete(n,t,e),s=h.transformIndexOnDelete(i,t,e);this._changeDetector.removeText(t,e),this._updateControl(),this._setTextSelection(r,s)},t.prototype.setText=function(t){this._assertBound(),this._changeDetector.setValue(t),this._updateControl(),this._setTextSelection(0,0)},t.prototype.getText=function(){return this._control.value},t.prototype._updateControl=function(){this._control.value=this._changeDetector.getValue()},t.prototype._assertBound=function(){if(null===this._changeDetector)throw new Error("The TextInputManager is not bound.")},t.prototype._getSelection=function(){return{start:this._control.selectionStart,end:this._control.selectionEnd}},t.prototype._setTextSelection=function(t,e){this._control.setSelectionRange(t,e)},t}(),p=function(){function t(t){var o=this;if(!t)throw new Error("options must be defined.");if(!t.control)throw new Error("options.control must be defined.");var e=t.control,n=t.onInsert,i=t.onDelete,r=void 0!==t.onSelectionChanged?t.onSelectionChanged:function(t){};this._inputManager=new u({control:e,onInsert:function(t,e){o._selectionManager.updateSelectionsOnInsert(t,e),n&&n(t,e)},onDelete:function(t,e){o._selectionManager.updateSelectionsOnDelete(t,e),i&&i(t,e)}}),this._selectionManager=new a({control:e,onSelectionChanged:r})}return t.prototype.insertText=function(t,e){this._inputManager.insertText(t,e),this._selectionManager.updateSelectionsOnInsert(t,e)},t.prototype.deleteText=function(t,e){this._inputManager.deleteText(t,e),this._selectionManager.updateSelectionsOnDelete(t,e)},t.prototype.setText=function(t){this._inputManager.setText(t)},t.prototype.getText=function(){return this._inputManager.getText()},t.prototype.selectionManager=function(){return this._selectionManager},t}();t.CollaborativeSelectionManager=a,t.CollaboratorSelection=l,t.TextInputManager=u,t.CollaborativeTextEditor=p,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=html-text-collab-ext.min.js.map
